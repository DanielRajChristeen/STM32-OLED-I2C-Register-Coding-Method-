#include "stm32f4xx.h"

/* ================= OLED ================= */
#define OLED_ADDR  (0x3C << 1) //0x78

/* ================= SIMPLE 6x8 FONT ================= */

/* 6x8 ASCII font, characters 32..126 */
typedef struct {
    char c;
    uint8_t data[6];
} FontChar;

const FontChar Font6x8[] = {
{' ',{0x00,0x00,0x00,0x00,0x00,0x00}},
{'!',{0x00,0x00,0x5F,0x00,0x00,0x00}},
{'"',{0x00,0x07,0x00,0x07,0x00,0x00}},
{'#',{0x14,0x7F,0x14,0x7F,0x14,0x00}},
{'$',{0x24,0x2A,0x7F,0x2A,0x12,0x00}},
{'%',{0x23,0x13,0x08,0x64,0x62,0x00}},
{'&',{0x36,0x49,0x55,0x22,0x50,0x00}},
{'\'',{0x00,0x05,0x03,0x00,0x00,0x00}},
{'(',{0x00,0x1C,0x22,0x41,0x00,0x00}},
{')',{0x00,0x41,0x22,0x1C,0x00,0x00}},
{'*',{0x14,0x08,0x3E,0x08,0x14,0x00}},
{'+',{0x08,0x08,0x3E,0x08,0x08,0x00}},
{',',{0x00,0x50,0x30,0x00,0x00,0x00}},
{'-',{0x08,0x08,0x08,0x08,0x08,0x00}},
{'.',{0x00,0x60,0x60,0x00,0x00,0x00}},
{'/',{0x20,0x10,0x08,0x04,0x02,0x00}},
{'0',{0x3E,0x51,0x49,0x45,0x3E,0x00}},
{'1',{0x00,0x42,0x7F,0x40,0x00,0x00}},
{'2',{0x42,0x61,0x51,0x49,0x46,0x00}},
{'3',{0x21,0x41,0x45,0x4B,0x31,0x00}},
{'4',{0x18,0x14,0x12,0x7F,0x10,0x00}},
{'5',{0x27,0x45,0x45,0x45,0x39,0x00}},
{'6',{0x3C,0x4A,0x49,0x49,0x30,0x00}},
{'7',{0x01,0x71,0x09,0x05,0x03,0x00}},
{'8',{0x36,0x49,0x49,0x49,0x36,0x00}},
{'9',{0x06,0x49,0x49,0x29,0x1E,0x00}},
{':',{0x00,0x36,0x36,0x00,0x00,0x00}},
{';',{0x00,0x56,0x36,0x00,0x00,0x00}},
{'<',{0x08,0x14,0x22,0x41,0x00,0x00}},
{'=',{0x14,0x14,0x14,0x14,0x14,0x00}},
{'>',{0x00,0x41,0x22,0x14,0x08,0x00}},
{'?',{0x02,0x01,0x51,0x09,0x06,0x00}},
{'@',{0x32,0x49,0x79,0x41,0x3E,0x00}},
{'A',{0x7E,0x11,0x11,0x11,0x7E,0x00}},
{'B',{0x7F,0x49,0x49,0x49,0x36,0x00}},
{'C',{0x3E,0x41,0x41,0x41,0x22,0x00}},
{'D',{0x7F,0x41,0x41,0x22,0x1C,0x00}},
{'E',{0x7F,0x49,0x49,0x49,0x41,0x00}},
{'F',{0x7F,0x09,0x09,0x09,0x01,0x00}},
{'G',{0x3E,0x41,0x49,0x49,0x7A,0x00}},
{'H',{0x7F,0x08,0x08,0x08,0x7F,0x00}},
{'I',{0x00,0x41,0x7F,0x41,0x00,0x00}},
{'J',{0x20,0x40,0x41,0x3F,0x01,0x00}},
{'K',{0x7F,0x08,0x14,0x22,0x41,0x00}},
{'L',{0x7F,0x40,0x40,0x40,0x40,0x00}},
{'M',{0x7F,0x02,0x04,0x02,0x7F,0x00}},
{'N',{0x7F,0x04,0x08,0x10,0x7F,0x00}},
{'O',{0x3E,0x41,0x41,0x41,0x3E,0x00}},
{'P',{0x7F,0x09,0x09,0x09,0x06,0x00}},
{'Q',{0x3E,0x41,0x51,0x21,0x5E,0x00}},
{'R',{0x7F,0x09,0x19,0x29,0x46,0x00}},
{'S',{0x46,0x49,0x49,0x49,0x31,0x00}},
{'T',{0x01,0x01,0x7F,0x01,0x01,0x00}},
{'U',{0x3F,0x40,0x40,0x40,0x3F,0x00}},
{'V',{0x1F,0x20,0x40,0x20,0x1F,0x00}},
{'W',{0x7F,0x20,0x18,0x20,0x7F,0x00}},
{'X',{0x63,0x14,0x08,0x14,0x63,0x00}},
{'Y',{0x07,0x08,0x70,0x08,0x07,0x00}},
{'Z',{0x61,0x51,0x49,0x45,0x43,0x00}},
{'[',{0x00,0x7F,0x41,0x41,0x00,0x00}},
{'\\',{0x02,0x04,0x08,0x10,0x20,0x00}},
{']',{0x00,0x41,0x41,0x7F,0x00,0x00}},
{'^',{0x04,0x02,0x01,0x02,0x04,0x00}},
{'_',{0x40,0x40,0x40,0x40,0x40,0x00}},
{'`',{0x00,0x01,0x02,0x04,0x00,0x00}},
{'a',{0x20,0x54,0x54,0x54,0x78,0x00}},
{'b',{0x7F,0x48,0x44,0x44,0x38,0x00}},
{'c',{0x38,0x44,0x44,0x44,0x20,0x00}},
{'d',{0x38,0x44,0x44,0x48,0x7F,0x00}},
{'e',{0x38,0x54,0x54,0x54,0x18,0x00}},
{'f',{0x08,0x7E,0x09,0x01,0x02,0x00}},
{'g',{0x18,0xA4,0xA4,0xA4,0x7C,0x00}},
{'h',{0x7F,0x08,0x04,0x04,0x78,0x00}},
{'i',{0x00,0x44,0x7D,0x40,0x00,0x00}},
{'j',{0x40,0x80,0x84,0x7D,0x00,0x00}},
{'k',{0x7F,0x10,0x28,0x44,0x00,0x00}},
{'l',{0x00,0x41,0x7F,0x40,0x00,0x00}},
{'m',{0x7C,0x04,0x18,0x04,0x78,0x00}},
{'n',{0x7C,0x08,0x04,0x04,0x78,0x00}},
{'o',{0x38,0x44,0x44,0x44,0x38,0x00}},
{'p',{0xFC,0x24,0x24,0x24,0x18,0x00}},
{'q',{0x18,0x24,0x24,0x18,0xFC,0x00}},
{'r',{0x7C,0x08,0x04,0x04,0x08,0x00}},
{'s',{0x48,0x54,0x54,0x54,0x20,0x00}},
{'t',{0x04,0x3F,0x44,0x40,0x20,0x00}},
{'u',{0x3C,0x40,0x40,0x20,0x7C,0x00}},
{'v',{0x1C,0x20,0x40,0x20,0x1C,0x00}},
{'w',{0x3C,0x40,0x30,0x40,0x3C,0x00}},
{'x',{0x44,0x28,0x10,0x28,0x44,0x00}},
{'y',{0x1C,0xA0,0xA0,0xA0,0x7C,0x00}},
{'z',{0x44,0x64,0x54,0x4C,0x44,0x00}},
{'{',{0x00,0x08,0x36,0x41,0x00,0x00}},
{'|',{0x00,0x00,0x7F,0x00,0x00,0x00}},
{'}',{0x00,0x41,0x36,0x08,0x00,0x00}},
{'~',{0x08,0x04,0x08,0x10,0x08,0x00}},
};

#define FONT_COUNT   (sizeof(Font6x8) / sizeof(Font6x8[0]))

/* ================= DELAY ================= */
void delay_ms(uint32_t ms)
{
    SysTick->LOAD = 16000 - 1;
    SysTick->VAL  = 0;
    SysTick->CTRL = SysTick_CTRL_ENABLE_Msk | SysTick_CTRL_CLKSOURCE_Msk;

    for(uint32_t i = 0; i < ms; i++)
        while(!(SysTick->CTRL & SysTick_CTRL_COUNTFLAG_Msk));

    SysTick->CTRL = 0;
}

/* ================= I2C (REGISTER) ================= */
void I2C1_Init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;
    RCC->APB1ENR |= RCC_APB1ENR_I2C1EN;

    /* PB8, PB9 AF4 */
    GPIOB->MODER &= ~((3<<(8*2)) | (3<<(9*2)));
    GPIOB->MODER |=  ((2<<(8*2)) | (2<<(9*2)));

    GPIOB->OTYPER |= (1<<8) | (1<<9);
    GPIOB->PUPDR  &= ~((3<<(8*2)) | (3<<(9*2)));
    GPIOB->PUPDR  |=  ((1<<(8*2)) | (1<<(9*2)));

    GPIOB->AFR[1] &= ~((0xF<<0) | (0xF<<4));
    GPIOB->AFR[1] |=  (4<<0) | (4<<4);

    I2C1->CR1 &= ~I2C_CR1_PE;
    I2C1->CR2 = 16;
    I2C1->CCR = 80;
    I2C1->TRISE = 17;
    I2C1->CR1 |= I2C_CR1_PE;
}

void I2C_Start(void)
{
    I2C1->CR1 |= I2C_CR1_START;
    while(!(I2C1->SR1 & I2C_SR1_SB));
}

void I2C_Address(uint8_t addr)
{
    I2C1->DR = addr;
    while(!(I2C1->SR1 & I2C_SR1_ADDR));
    (void)I2C1->SR2;
}

void I2C_Write(uint8_t data)
{
    while(!(I2C1->SR1 & I2C_SR1_TXE));
    I2C1->DR = data;
}

void I2C_Stop(void)
{
    while(!(I2C1->SR1 & I2C_SR1_BTF));
    I2C1->CR1 |= I2C_CR1_STOP;
}

/* ================= OLED ================= */
void OLED_Command(uint8_t cmd)
{
    I2C_Start();
    I2C_Address(OLED_ADDR);
    I2C_Write(0x00);
    I2C_Write(cmd);
    I2C_Stop();
}

void OLED_Data(uint8_t data)
{
    I2C_Start();
    I2C_Address(OLED_ADDR);
    I2C_Write(0x40);
    I2C_Write(data);
    I2C_Stop();
}

void OLED_SetCursor(uint8_t x, uint8_t page)
{
    OLED_Command(0xB0 + page);
    OLED_Command(0x00 + (x & 0x0F));
    OLED_Command(0x10 + (x >> 4));
}

void OLED_Clear(void)
{
    for(uint8_t p=0;p<8;p++)
    {
        OLED_SetCursor(0,p);
        for(uint8_t c=0;c<128;c++)
            OLED_Data(0x00);
    }
}

void OLED_Init(void)
{
    delay_ms(100);
    OLED_Command(0xAE);
    OLED_Command(0xA8); OLED_Command(0x3F);
    OLED_Command(0xD3); OLED_Command(0x00);
    OLED_Command(0x40);
    OLED_Command(0xA1);
    OLED_Command(0xC8);
    OLED_Command(0xDA); OLED_Command(0x12);
    OLED_Command(0x81); OLED_Command(0x7F);
    OLED_Command(0xA4);
    OLED_Command(0xA6);
    OLED_Command(0xD5); OLED_Command(0x80);
    OLED_Command(0x8D); OLED_Command(0x14);
    OLED_Command(0xAF);
}

void OLED_DrawChar(char c)
{
    for (uint32_t i = 0; i < FONT_COUNT; i++)
    {
        if (Font6x8[i].c == c)
        {
            for (uint8_t j = 0; j < 6; j++)
            {
                OLED_Data(Font6x8[i].data[j]);
            }
            return;
        }
    }

    // Unknown char â†’ space
    for (uint8_t j = 0; j < 6; j++)
    {
        OLED_Data(0x00);
    }
}


void OLED_DrawString(uint8_t x, uint8_t page, const char *str)
{
    OLED_SetCursor(x, page);

    while (*str)
    {
        OLED_DrawChar(*str++);
    }
}


/* ================= MAIN ================= */
int main(void)
{
    I2C1_Init();
    OLED_Init();
    OLED_Clear();

    OLED_DrawString(0, 0, "STM32F446");
    OLED_DrawString(0, 2, "STM32 OLED I2C");
    OLED_DrawString(0, 4, "DANIEL RAJ.C");
    OLED_DrawString(0, 6, "_____________");

    while (1);
}
